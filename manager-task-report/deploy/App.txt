<!DOCTYPE html>
<html>
<head>
    <title>Manager Task Report</title>
    <!--  (c) 2016 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Sun Jun 26 2016 21:03:50 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Sun Jun 26 2016 21:03:50 GMT-0600 (MDT)";
        var BUILDER = "kcorkan";
        var CHECKSUM = 40146791393;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Rally.ui.dialog.Dialog',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
    title: "Build Information",
    
    defaults: { padding: 5, margin: 5 },

    closable: true,
     
    draggable: true,

    autoShow: true,
   
    width: 350,
    
    informationalConfig: null,
    
    items: [{xtype:'container', itemId:'information' }],
    
    initComponent: function() {
        var id = Ext.id(this);
        this.title =  "<span class='icon-help'> </span>" + this.title;
        this.callParent(arguments);
    },
    
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/var BUILDER = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
       
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
   
        return chk;
    },
    
    _checkChecksum: function(container) {
        var deferred = Ext.create('Deft.Deferred');
        var me = this;
        
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    var stored_checksum = me._generateChecksum(text);
                    if ( CHECKSUM !== stored_checksum ) {
                        deferred.resolve(false);
                        return;
                    }
                }
                deferred.resolve(true);
            }
        });
        
        return deferred.promise;
    },
    
    _addToContainer: function(container){
        var config = Ext.apply({
            xtype:'container',
            height: 200,
            overflowY: true
        }, this.informationalConfig);
        
        container.add(config);
    },
    
    afterRender: function() {
        var app = Rally.getApp();
        
        if ( !Ext.isEmpty( this.informationalConfig ) ) {
            var container = this.down('#information');
            this._addToContainer(container);
            
        }
        
        if (! app.isExternal() ) {
            this._checkChecksum(app).then({
                scope: this,
                success: function(result){
                    if ( !result ) {
                        this.addDocked({
                            xtype:'container',
                            cls: 'build-info',
                            dock: 'bottom',
                            padding: 2,
                            html:'<span class="icon-warning"> </span>Checksums do not match'
                        });
                    }
                },
                failure: function(msg){
                    console.log("oops:",msg);
                }
            });
        } else {
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html:'... Running externally'
            });
        }
        this.callParent(arguments);
    },
    
    beforeRender: function() {
        var me = this;
        this.callParent(arguments);

        if (this.informationHtml) {
            this.addDocked({
                xtype: 'component',
                componentCls: 'intro-panel',
                padding: 2,
                html: this.informationHtml,
                doc: 'top'
            });
        }
        
        this.addDocked({
            xtype:'container',
            cls: 'build-info',
            padding: 2,
            dock:'bottom',
            html:"This app was created by the CA AC Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            this.addDocked({
                xtype:'container',
                cls: 'build-info',
                padding: 2,
                dock: 'bottom',
                html: Ext.String.format("Build date/time: {0} ({1})",
                    APP_BUILD_DATE,
                    BUILDER)
            });
        }
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define("CArABU.technicalservices.BurndownCalculator", {
    extend: "Rally.data.lookback.calculator.TimeSeriesCalculator",
    completedStates: ['Completed'],

    getDerivedFieldsOnInput: function() {

        return [
            {
                "as": "Estimated",
                "f": function(snapshot) {
                    if (snapshot.Estimate) {
                        return snapshot.Estimate;
                    }

                    return 0;
                }
            },
            {
                "as": "Remaining",
                "f": function(snapshot) {
                    if (snapshot.ToDo){ //(_.contains(completedScheduleStateNames, snapshot.ScheduleState) && snapshot.PlanEstimate) {
                        return snapshot.ToDo;
                    }
                    return 0;
                }
            }
        ];
    },

    getMetrics: function() {
        return [
            {
                "field": "Estimated",
                "as": "Estimated",
                "display": "line",
                "f": "sum"
            },
            {
                "field": "Remaining",
                "as": "Remaining",
                "f": "sum",
                "display": "column"
            }
        ];
    }
});
Ext.define('CArABU.technicalservices.ManagerTaskReport.Settings',{
    singleton: true,
    getFields: function(){
        var width = 400,
            labelWidth = 200;

        var isNotHidden = function(field){
            return field.custom && field.attributeDefinition && field.attributeDefinition.AttributeType === "STRING";
        };

        return [{
                xtype: 'rallyfieldcombobox',
                fieldLabel: 'Is Manager Field',
                labelAlign: 'right',
                name: 'isManagerField',
                model: 'User',
                width: width,
                labelWidth: labelWidth,
            _isNotHidden: isNotHidden
            },{
                xtype: 'rallyfieldcombobox',
                fieldLabel: 'Manager Employee ID Field',
                labelAlign: 'right',
                name: 'managerEmployeeIDField',
                model: 'User',
                width: width,
                labelWidth: labelWidth,
            _isNotHidden: isNotHidden
            },{
                xtype: 'rallyfieldcombobox',
                fieldLabel: 'Employee ID Field',
                labelAlign: 'right',
                name: 'employeeIDField',
                model: 'User',
                width: width,
                labelWidth: labelWidth,
                _isNotHidden: isNotHidden
        },{
            xtype: 'rallycheckboxfield',
            fieldLabel: 'Show Historical Data',
            labelAlign: 'right',
            labelWidth: labelWidth,
            name: 'showHistoricalData'
        }];
    }
});

Ext.define('CArABU.technicalservices.ModelBuilder',{
    singleton: true,

    build: function(modelType, newModelName) {
        var deferred = Ext.create('Deft.Deferred');

        Rally.data.ModelFactory.getModel({
            type: modelType,
            success: function (model) {

                var default_fields = [{
                    name: "New Field",
                    defaultValue: 19
                }];

                var new_model = Ext.define(newModelName, {
                    extend: model,
                    logger: new Rally.technicalservices.Logger(),
                    fields: default_fields
                });
                deferred.resolve(new_model);
            }
        });
        return deferred;
    }
});
Ext.define('CArABU.technicalservices.UserManagerStore',{
    logger: new Rally.technicalservices.Logger(),
    mixins: {
        observable: 'Ext.util.Observable'
    },

    fetch: ['UserName','Email','First Name','Last Name','DisplayName'],

    constructor: function(config){
        Ext.apply(this,config);
        this.mixins.observable.constructor.call(this, config);

        this.employeeIDField = config.employeeIDField;
        this.managerIDField = config.managerEmployeeIDField;
        this.costCenterField = config.costCenterField;
        this.isManagerField = config.isManagerField;

        this._loadUserModel().then({
            success: function(model){
                if (this._validateFields(model)){
                    this.fireEvent('ready');
                }
            },
             scope: this
        });
    },
    _loadUserModel: function(){
        return Rally.data.ModelFactory.getModel({
            type: 'User'
        });
    },
    _validateFields: function(model){
        var missingFields = [];
        if (!model.getField(this.employeeIDField)){
            missingFields.push("Employee ID Field (" + this.employeeIDField + ")");
        }
        if (!model.getField(this.managerIDField)){
            missingFields.push("Manager ID Field (" + this.managerIDField + ")");
        }
        if (!model.getField(this.costCenterField)){
            missingFields.push("Cost Center Field (" + this.costCenterField + ")");
        }
        if (missingFields.length > 0){
            this.fireEvent('configurationerror', Ext.String.format("The following custom fields are missing from the User Model:<br/>{0}<br/><br/> Please add these fields or use the app settings to configure the appropriate fields.", missingFields.join('<br/>')))
            return false;
        }
        return true;

    },

    buildManagerTree: function(managerId, records){
        this.logger.log('buildManagerTree', this.managerEmployeeIDField, this.employeeIDField);
        var managerTree = Ext.create('CArABU.technicalservices.UserTree',{
            root: managerId,
            users: records,
            managerIDField: this.managerEmployeeIDField,
            employeeIDField: this.employeeIDField
        });
        this.logger.log('buildManagerTree managerTree', managerTree);
        return managerTree;
    }
});

Ext.define('CArABU.technicalservices.UserTreeItem',{
    empId: null,
    children: null,
    leaf: true,
    tasks: null,

    constructor: function(config) {
        this.employeeId = config && config.employeeId || null;
        this.timestamp = new Date();
    },
    setUserData: function(userData){
        if (!this.userName){
            this.userName = userData.UserName || null;
        }
        if (!this.displayName){
            this.displayName = userData.DisplayName || userData._refObjectName || userData.UserName;
            if (userData.FirstName && userData.LastName){
                this.displayName = userData.FirstName + ' ' + userData.LastName;
            }
        }
        this.objectID = userData.ObjectID || null;
    },
    addChild: function(child){

        //Check that child doesn't already exist...
        var existingChild = Ext.Array.findBy(this.getChildren(), function(item){return item.employeeId.toString() === child.employeeId.toString();});
        if (!existingChild) {
            this.getChildren().push(child);
        }
        this.leaf = false;
    },
    getChildren: function(){
        console.log('getChildren', this.displayName, this.timestamp, Ext.clone(this.children), this.children);
        if (!this.children){
            this.children = [];
        }
        return this.children;
    },
    addTasks: function(tasks, historical){
        var userTasks = [];
        Ext.Array.each(tasks, function(t){
            userTasks.push({
                ObjectID: t.get('ObjectID'),
                ToDo: t.get('ToDo'),
                Estimate: t.get('Estimate'),
                State: t.get('State')
            });
        });
        if (historical){
            this.historicalTasks = userTasks;
        } else {
            this.taskIds = _.pluck(userTasks, 'ObjectID');
            this.currentTasks = userTasks;
        }
    },
    getCurrentTasks: function(){
        return this.currentTasks || [];
    },
    getHistoricalTasks: function(){
        return this.historicalTasks || [];
    },
    doCalculations: function(noRollup) {
        this.ToDo = 0;
        this.numDefined = 0;
        this.numInProgress = 0;
        this.numCompleted = 0;
        this.totalCount = 0;
        this.totalEffort = 0;

        if (!noRollup){
            Ext.Array.each(this.getChildren(), function (child) {
                child.doCalculations();
                this.ToDo += child.ToDo;
                this.numDefined += child.numDefined;
                this.numInProgress += child.numInProgress;
                this.numCompleted += child.numCompleted;
                this.totalEffort += child.totalEffort;
                this.totalCount += child.totalCount;
                this.taskIds = Ext.Array.merge(this.taskIds, child.taskIds || []);
            }, this);
        }

        this.ToDo += Ext.Array.sum(Ext.Array.pluck(this.getCurrentTasks(), 'ToDo'));
        this.totalCount += this.getCurrentTasks().length;
        this.totalEffort += Ext.Array.sum(Ext.Array.pluck(this.getCurrentTasks(), 'Estimate'));
        this.numDefined += Ext.Array.filter(this.getCurrentTasks(), function(t){ return t.State === "Defined"; }).length;
        this.numInProgress += Ext.Array.filter(this.getCurrentTasks(), function(t){ return t.State === "In-Progress"; }).length;
        this.numCompleted += Ext.Array.filter(this.getCurrentTasks(), function(t){ return t.State === "Completed"; }).length;

        this.pctCompleteEffort = this.totalEffort > 0 ? (this.totalEffort - this.ToDo)/this.totalEffort : 0;
        this.pctCompleteCount = this.totalCount > 0 ? this.numCompleted/this.totalCount : 0;
    },
    doHistoricalCalculations: function(noRollup){
        this.historicalToDo = 0;

        if (!noRollup){
            Ext.Array.each(this.getChildren(), function (child) {
                child.doHistoricalCalculations();
                this.historicalToDo += child.historicalToDo;
            }, this);
        }
        this.historicalToDo += Ext.Array.sum(Ext.Array.pluck(this.getHistoricalTasks(), 'ToDo'));

        this.deltaToDo = this.historicalToDo - this.ToDo;
    }

});

Ext.define('CArABU.technicalservices.UserTree',{
    logger: new Rally.technicalservices.Logger(),
    constructor: function(config){
        this.logger.log('config', config);
        var users = config && config.users || [];
        var managerId = config && config.managerId || null;

        this.employeeIDField = config.employeeIDField;
        this.managerIDField = config.managerIDField;

        if (users && users.length > 0){
            this._initializeUsers(users, managerId);
        }

    },
    _initializeUsers: function(users, rootId){
        Ext.Array.each(users, function(r){
            var empId = r.get(this.employeeIDField);
            if (empId){
                var userObj = this.getUserItem(empId),
                    mgrID = r.get(this.managerIDField);

                userObj.setUserData(r.getData());

                if (mgrID && mgrID.length > 0){
                    var mgrObj = this.getUserItem(mgrID);
                    mgrObj.addChild(userObj);
                }
            }
            console.log('users', this.userTree, empId, this.employeeIDField);
        }, this);

        //Todo clean out all users other than root.
        this.logger.log('_initializeUsers', this.userTree);
    },
    getAllChildrenEmployeeIds: function(empId){
        var user = this.getUserItem(empId),
            ids = [empId],
            children = user.getChildren();
        console.log('--ids', ids, user);
        Ext.Array.each(children, function(c){
            ids = ids.concat(this.getAllChildrenEmployeeIds(c.employeeId, true));
        }, this);
        this.logger.log('getAllChildrenEmployeeIds', empId, ids);
        return ids;
    },
    getUserItem: function(employeeId){
            if (!this.userTree){
                this.userTree = {};
            }
            employeeId = employeeId.toString();
            console.log('getUserItem', employeeId,this.userTree[employeeId] );
            if (!this.userTree[employeeId]){
                this.userTree[employeeId] = Ext.create('CArABU.technicalservices.UserTreeItem',{
                    employeeId: employeeId
                }); //{text: employeeId, empId: employeeId, user: null, children: [], leaf: true, tasks: []};
            }
            return this.userTree[employeeId];
    },

    processTasks: function(records, snapshots, managerId){
        var employeeIdField = this.employeeIDField,
            managerIDField = this.managerIDField,
            tasksByEmpId = {};
        this.logger.log('processTasks', this.userTree);
        Ext.Array.each(records, function(r){
            var empId = r.get('Owner') && r.get('Owner')[employeeIdField];
            if (empId){
                if (!tasksByEmpId[empId]){
                    tasksByEmpId[empId] = [];
                }
                tasksByEmpId[empId].push(r);
            }
        });

        Ext.Object.each(tasksByEmpId, function(empId, tasks){
            if (empId && tasks && tasks.length > 0){
                var owner = tasks[0].get('Owner'),
                    mgrID =owner && owner[managerIDField];

                var userObj = this.getUserItem(empId);
                userObj.setUserData(owner);
                console.log('owner',owner);

                userObj.addTasks(tasks);
                if (mgrID && mgrID.length > 0){
                    var mgrObj = this.getUserItem(mgrID);
                    console.log('mgrId',mgrID,mgrObj,mgrObj.displayName);
                    mgrObj.addChild(userObj);
                }
            }
        }, this);

        var snapsByOwner = {},
            userOids = [];
        Ext.Array.each(snapshots, function(s){
            var objectID = s.get('Owner').toString();
            if (!snapsByOwner[objectID]){
                snapsByOwner[objectID] = [];
                userOids.push(objectID.toString());
            }
            snapsByOwner[objectID].push(s);

        });

        var usersByObjectID = {};
        Ext.Object.each(this.userTree, function(empId, user){
            var userObjectId = user.objectID && user.objectID.toString() || 0;
            if (Ext.Array.contains(userOids, userObjectId)){
                usersByObjectID[userObjectId] = user;
            }
        });

        Ext.Object.each(snapsByOwner, function(objectId, snaps){
            var userObject = usersByObjectID[objectId.toString()];
            if (userObject){
                userObject.addTasks(snaps, true);
            }
        });
        this.getUserItem(managerId).doCalculations();
        this.getUserItem(managerId).doHistoricalCalculations();

        this.logger.log('processTasks manager', this.getUserItem(managerId));
    }
});


Ext.define("CArABU.technicalservices.UserSummaryTaskModel", {
    extend: "Ext.data.TreeModel",

    fields: [{
        name: 'employeeId',
        displayName: 'Employee ID',
        defaultValue: null
    },{
        name: "displayName",
        displayName: "Owner"
    },{
        name: "numDefined"
    },{
        name: "numInProgress"
    },{
        name: "numCompleted"
    },{
        name: "ToDo"
    },{
        name: 'pctCompleteCount'
    },{
        name: 'pctCompleteEffort'
    },{
        name: 'deltaToDo'
    },{
        name: 'taskIds'
    }]
});

Ext.define("manager-task-report", {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    defaults: { margin: 10 },

    config: {
        defaultSettings: {
            employeeIDField: 'c_EmployeeId',
            managerEmployeeIDField: 'c_ManagerEmployeeId',
            costCenterField: 'CostCenter',
            costCenter: null,
            isManagerField: 'c_IsManager',
            showHistoricalData: true,
            daysBack: 14
        }
    },

    items: [
        {xtype:'container',itemId:'manager_box',layout:'hbox'},
        {xtype:'container',itemId:'display_box'},
        {xtype:'container',itemId:'detail_box'}
    ],

    integrationHeaders : {
        name : "manager-task-report"
    },
                        
    launch: function() {
        this.logger.log('launch')
        this.userManagerStore = Ext.create('CArABU.technicalservices.UserManagerStore',{
            employeeIDField: this.getEmployeeIDField(),
            managerEmployeeIDField: this.getManagerEmployeeIDField(),
            costCenterField: this.getCostCenterField(),
            costCenter: this.getCostCenter(),
            context: this.getContext(),
            isManagerField: this.getIsManagerField()
        });
        this.userManagerStore.on('ready', this._initializeApp, this);
        this.userManagerStore.on('configurationerror', this._showConfigurationError, this);
    },
    _showConfigurationError: function(msg){
        this.down('#display_box').removeAll();
        this.down('#detail_box').removeAll();
        this.down('#display_box').add({
            xtype: 'container',
            html: msg,
            cls: "configuration-error"
        });
    },
    showHistoricalData: function(){
        return this.getSetting('showHistoricalData') === "true" || this.getSetting('showHistoricalData') === true;
    },
    getHistoricalDate: function(){
        var daysBack = this.getSetting('daysBack') || 7;
        return Rally.util.DateTime.toIsoString(Rally.util.DateTime.add(new Date(),'day',daysBack));
    },
    getIsManagerField: function(){
        return this.getSetting('isManagerField');
    },
    getEmployeeIDField: function(){
        return this.getSetting('employeeIDField');
    },
    getManagerEmployeeIDField: function(){
        return this.getSetting('managerEmployeeIDField');
    },
    getCostCenterField: function(){
        return this.getSetting('costCenterField');
    },
    getCostCenter: function(){
        return this.getSetting('costCenter');
    },
    getTaskFetchList: function(){
        return ['ObjectID','FormattedID','Name','ToDo','Estimate','State','Owner','Milestones',this.getEmployeeIDField(),this.getManagerEmployeeIDField()];
    },
    _getAllManagerFilters: function(){
        return [{
            property: this.getEmployeeIDField(),
            operator: "!=",
            value: ""
        },{
            property: this.getIsManagerField(),
            value: 'Y'
        }];
    },
    _getUserFetch: function(){
        return ['ObjectID','UserName','Email','First Name','Last Name','DisplayName'].concat([this.getEmployeeIDField(), this.getManagerEmployeeIDField(), this.getIsManagerField()]);
    },
    _updateManagers: function(store, records, success){
        this.logger.log('_updateManagers', store, records);
        this.managerRecords = null;
        if (success){
            this.managerRecords = records;
        } else {
            Rally.ui.notify.Notifier.showError({message: 'Error loading managers.'});
        }
    },
    _addIterationFilter: function(){
        this.down('#manager_box').add({
            xtype: 'rallyiterationcombobox',
            fieldLabel: 'Iteration',
            labelAlign: 'right'
        });
    },
    _addManagerFilters: function(){
        var employeeIDField = this.getEmployeeIDField();

        this.down('#manager_box').add({
            xtype: 'rallyusercombobox',
            fieldLabel: 'Manager',
            labelAlign: 'right',
            allowNoEntry: true,
            value: null,
            width: 300,
            remoteFilter: false,
            storeConfig: {
                filters: this._getAllManagerFilters(),
                fetch: this._getUserFetch(),
                limit: 'Infinity',
                autoLoad: true,
                listeners: {
                    scope: this,
                    load: this._updateManagers,
                    single: true
                }
            },
            valueField: employeeIDField,
            displayField: "DisplayName"

        });
    },
    _clearApp: function(){
        this.down('#display_box').removeAll();
        this.down('#detail_box').removeAll();
    },
    _initializeApp: function(){
        this.logger.log('_initializeApp');
        this._clearApp();
        this.down('#manager_box').removeAll();


        this._addIterationFilter();
        this._addManagerFilters();

        var btn = this.down('#manager_box').add({
            xtype: 'rallybutton',
            text: 'Update'
        });
        btn.on('click', this._fetchTasks, this);

    },
    getSelectedManagerId: function(){
        return this.down('rallyusercombobox') && this.down('rallyusercombobox').getValue() || null;
    },
    getSelectedIterationFilter: function(){
        var iterationRecord = this.down('rallyiterationcombobox') && this.down('rallyiterationcombobox').getRecord();
        if (iterationRecord){
            return Rally.data.wsapi.Filter.and([{
                property: 'WorkProduct.Iteration.Name',
                value: iterationRecord.get('Name')
            },{
                property: 'WorkProduct.Iteration.StartDate',
                value: iterationRecord.get('StartDate')
            },{
                property: 'WorkProduct.Iteration.EndDate',
                value: iterationRecord.get('EndDate')
            }]);
        }
        return null;
    },
    getManagerRecords: function(){
        this.logger.log('thi',this.down('rallyusercombobox').getStore().getRange());
       return this.managerRecords;
    },
    _getWsapiTaskFilters: function(empId, includeEmployeeTasks){
        var managerIds = this.userTree.getAllChildrenEmployeeIds(empId,includeEmployeeTasks),
            managerIDField = this.getManagerEmployeeIDField(),
            filters = _.map(managerIds, function(id){
                return {
                    property: 'Owner.' + managerIDField,
                    value: id
                };
            });

        this.logger.log('_getWsapiTaskFilters managerIds', managerIds);
        if (includeEmployeeTasks){
            filters.push({
                property: 'Owner.' + this.getEmployeeIDField(),
                value: empId
            });
        }

        filters = Rally.data.wsapi.Filter.or(filters);
        var iterationFilter = this.getSelectedIterationFilter();
        if (iterationFilter){
            this.logger.log('iterationFilter', iterationFilter.toString());
            filters = filters.and(iterationFilter);

        }
        this.logger.log('_getWsapiTaskFilters',filters.toString());
        return filters;
    },
    _fetchTasks: function(){
        var managerId = this.getSelectedManagerId();
        this._clearApp();
        this.logger.log('_fetchTasks', this.getSelectedManagerId());

        if (!managerId){
            Rally.ui.notify.Notifier.showWarning({message: "Please select a manager."});
            return;
        }

        this.userTree = this.userManagerStore.buildManagerTree(managerId, this.getManagerRecords());
        var filters = this._getWsapiTaskFilters(managerId, false);
        ////First we need to get all the possible managers
        //var managerIds = this.userTree.getAllChildrenEmployeeIds(managerId),
        //    managerIDField = this.getManagerEmployeeIDField(),
        //    filters = _.map(managerIds, function(id){
        //        return {
        //            property: 'Owner.' + managerIDField,
        //            value: id
        //        };
        //    });
        //
        //filters = Rally.data.wsapi.Filter.or(filters);
        //var iterationFilter = this.getSelectedIterationFilter();
        //if (iterationFilter){
        //    this.logger.log('iterationFilter', iterationFilter.toString());
        //    filters = filters.and(iterationFilter);
        //
        //}


        Ext.create('Rally.data.wsapi.Store',{
            model: 'Task',
            filters: filters,
            fetch: this.getTaskFetchList(),
            limit: 'Infinity',
            pageSize: 1000
        }).load({
            callback: this._createSummaryGrid,
            scope: this
        });

    },
    _createSummaryGrid: function(records, operation){
        this.logger.log('_createSummaryGrid', records, operation);

        this.down('#display_box').removeAll();
        this.down('#detail_box').removeAll();

        if (!operation.wasSuccessful()){
            Rally.ui.notify.Notifier.showError({ message: "Error fetching Tasks:  " + operation.error.errors.join(',') });
            return;
        }

        this._fetchHistoricalSummaryTasks(records).then({
            success: function(snapshots){
                var summaryStore = this._buildSummaryStore(records, snapshots);
                this.logger.log('_createSummaryGrid', summaryStore);
                this.down('#display_box').add({
                    xtype: 'treepanel',
                    itemId: 'summary-grid',
                    cls: 'rally-grid',
                    padding: 25,
                    selModel: Ext.create("Ext.selection.RowModel",{
                        listeners: {
                            select: this._showDetails,
                            scope: this
                        }
                    }),
                    store: summaryStore,
                    rootVisible: false,
                    columns: this._getSummaryStoreColumnCfgs()
                });


            },
            scope: this
        });
    },
    _fetchHistoricalSummaryTasks: function(currentTaskRecords){
        var deferred = Ext.create('Deft.Deferred'),
            maxObjectIds = 25;

        if (!this.showHistoricalData()){
            deferred.resolve([]);
        }

        var tasks = Ext.Array.map(currentTaskRecords, function(r){
            return r.get('ObjectID');
        });
        this.logger.log('_fetchHistoricalSummaryTasks users', tasks);

        var promises = [];
        for (var i= 0, j=tasks.length; i<j; i+=maxObjectIds){
            var tempArray = tasks.slice(i,i+maxObjectIds);
            promises.push(this._fetchLookbackData({
                fetch: ['ObjectID','_ItemHierarchy','ToDo','Estimate','State','Owner'],
                find: {
                    ObjectID: {$in: tempArray},
                    __At: this.getHistoricalDate()
                },
                limit: 'Infinity'
            }));
        }
        Deft.Promise.all(promises).then({
            success: function(results){
                deferred.resolve(_.flatten(results));
            },
            failure: function(msg){
                Rally.ui.notify.Notifier.showError({ message: "Error loading historical task summary data:  " + msg });
                deferred.resolve([]);
            }
        });

        return deferred;
    },
    _fetchLookbackData: function(config){
        var deferred = Ext.create('Deft.Deferred');

        Ext.create('Rally.data.lookback.SnapshotStore',config).load({
            callback: function(records, operation){
                if (operation.wasSuccessful()){
                    deferred.resolve(records);
                } else {
                    var msg = operation && operation.error && operation.error.errors.join(',') || "No Response provided - The connection may have been closed because the request was too big or timed out." ;
                    deferred.reject(msg);
                }
            }
        });

        return deferred;
    },
    _showDetails: function(store, record, index){
        this.logger.log('_rowSelected',record, index);

        this.down('#detail_box').removeAll();

        var defaultShowGrid = this.showGridState || true;

        this.down('#detail_box').add({
            xtype: 'container',
            layout:'hbox',
            padding: 0,
            items: [{
                xtype: 'rallybutton',
                iconCls: 'icon-graph',
                cls: 'secondary rly-small',
                pressedCls: 'primary rly-small',
                toggleGroup: 'detailView',
                enableToggle: true,
                pressed: !defaultShowGrid,
                scope: this,
                listeners: {
                    toggle: function(btn, state){
                        this._toggleDetail(btn,state,record);
                    },
                    scope: this
                }
            },{
                xtype: 'rallybutton',
                itemId: 'btn-grid',
                iconCls: 'icon-grid',
                cls: 'secondary rly-small',
                pressedCls: 'primary rly-small',
                toggleGroup: 'detailView',
                enableToggle: true,
                scope: this,
                pressed: defaultShowGrid,
                listeners: {
                    toggle: function(btn, state){
                        this._toggleDetail(btn,state,record);
                    },
                    render: function(btn){

                        this._toggleDetail(btn, defaultShowGrid, record);
                    },
                    scope: this
                }
            }]
        });



    },
    _toggleDetail: function(btn, state, record){

        var showGrid = true;
        if ((btn.iconCls === 'icon-graph' && state === true) || (btn.iconCls === 'icon-grid' && state===false)){
            showGrid = false;
        }
        this.showGridState = showGrid;
        this.logger.log('_toggleDetail', btn.iconCls, state, showGrid, record);

        if (state){
            btn.removeCls('secondary');
            btn.addCls('primary');
        } else {
            btn.removeCls('primary');
            btn.addCls('secondary');
        }


        this.down('rallygridboard')  && this.down('rallygridboard').destroy();
        this.down('rallychart') && this.down('rallychart').destroy();

        //var empId = record.get('empId'),
        //    user = this.userTree.getUserItem(empId);

        if (showGrid){
            this._addDetailGrid(record);
        } else {
            this._addDetailChart(record);
        }

    },
    _addDetailChart: function(user){
        var objectIDFilters = user.get('taskIds') || [];

        if (objectIDFilters.length ===0){
            objectIDFilters.push(0);
        }

        this.down('#detail_box').add({
            xtype: 'rallychart',
            storeType: 'Rally.data.lookback.SnapshotStore',
            storeConfig: {
                find: {
                    _TypeHierarchy: 'Task',
                    ObjectID: {$in: objectIDFilters}
                },
                fetch: ['ToDo', 'Estimate','State','_ValidTo','_ValidFrom'],
                hydrate: ['State'],
                removeUnauthorizedSnapshots: true
            },

            calculatorType: 'CArABU.technicalservices.BurndownCalculator',
            calculatorConfig: {},
            chartConfig: {
                chart: {
                    defaultSeriesType: 'area',
                    zoomType: 'xy'
                },
                title: {
                    text: 'Task Burndown'
                },
                xAxis: {
                    categories: [],
                    tickmarkPlacement: 'on',
                    tickInterval: 5,
                    title: {
                        text: 'Date',
                        margin: 10
                    }
                },
                yAxis: [
                    {
                        title: {
                            text: 'Hours'
                        }
                    }
                ],
                tooltip: {
                    formatter: function() {
                        return '' + this.x + '<br />' + this.series.name + ': ' + this.y;
                    }
                },
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false,
                            states: {
                                hover: {
                                    enabled: true
                                }
                            }
                        },
                        groupPadding: 0.01
                    },
                    column: {
                        stacking: null,
                        shadow: false
                    }
                }
            }
        });

    },
    _addDetailGrid: function(user){
        //var tasks = user.get('taskIds') || [];
        //
        //if (tasks.length === 0){
        //    tasks[0] = 0;
        //}
        //this.logger.log('_addDetailGrid', user);
        //var filters = _.map(tasks, function(t){ return {
        //    property: 'ObjectID',
        //    value: t
        //    }
        //});
        //filters = Rally.data.wsapi.Filter.or(filters);

        var filters = this._getWsapiTaskFilters(user.get('employeeId'), true);



        this.logger.log('_addDetailGrid filters', filters.toString());

                Ext.create('Rally.data.wsapi.TreeStoreBuilder').build({
                    models: ['task'],
                    autoLoad: false,
                    enableHierarchy: true,
                    filters: filters
                }).then({
                    success: function(store) {
                        this.down('#detail_box').add({
                            xtype: 'rallygridboard',
                            context: this.getContext(),
                            modelNames: ['task'],
                            stateful: false,
                            stateId: "grid-2",
                            itemId: 'detail-grid',
                            toggleState: 'grid',
                            plugins: [{
                                ptype: 'rallygridboardfieldpicker',
                                headerPosition: 'left',
                                modelNames: ['extendedTask'],
                                stateful: true,
                                stateId: this.getContext().getScopedStateId('detail-columns-2')
                            },{
                                ptype: 'rallygridboardinlinefiltercontrol',
                                inlineFilterButtonConfig: {
                                    stateful: true,
                                    stateId: this.getContext().getScopedStateId('detail-filters'),
                                    modelNames: ['task'],
                                    inlineFilterPanelConfig: {
                                        quickFilterPanelConfig: {
                                            defaultFields: [
                                                'ArtifactSearch',
                                                'Owner',
                                                'State'
                                            ]
                                        }
                                    }
                                }
                            },{
                                ptype: 'rallygridboardactionsmenu',
                                menuItems: [
                                    {
                                        text: 'Export...',
                                        handler: function() {
                                            window.location = Rally.ui.gridboard.Export.buildCsvExportUrl(
                                                this.down('rallygridboard').getGridOrBoard());
                                        },
                                        scope: this
                                    }
                                ],
                                buttonConfig: {
                                    iconCls: 'icon-export'
                                }
                            }],
                            cardBoardConfig: {
                                attribute: 'State'
                            },
                            gridConfig: {
                                store: store,
                                storeConfig: {
                                    filters: filters,
                                    load: function(store, records, success){
                                        console.log('load', records)
                                    }
                                },
                                rankColumnDataIndex: 'TaskIndex',
                                columnCfgs: [
                                    'FormattedID',
                                    'Name',
                                    'State',
                                    'Owner',
                                    'ToDo'
                                ]
                            },
                            height: 400
                        });
                    },
                    scope: this
                });




    },
    _getDetailColumnCfgs: function(){
        return [{
            dataIndex: 'FormattedID'
        },{
            dataIndex: 'Name',
            text: 'Name',
            flex: 1
        },{
            dataIndex: 'ToDo',
            text: 'Todo'
        },{
            dataIndex: 'State'
        },{
            dataIndex: 'Owner',
            text: 'Owner',
            flex: 1,
            renderer: function(v,m,r){
                return v._refObjectName;
            }
        }];
    },
    _getSummaryStoreColumnCfgs: function(){
        var columns = [
            {
                xtype: 'treecolumn',
                text: 'Owner',
                menuDisabled: true,
                dataIndex: 'displayName',
                flex: 1
            },{
                text:'Defined',
                menuDisabled: true,
                dataIndex:'numDefined'
            },{
                text:'In Progress',
                menuDisabled: true,
                dataIndex:'numInProgress'
            },{
                text:'Completed',
                menuDisabled: true,
                dataIndex:'numCompleted'
            },{
                text: 'Total ToDo',
                menuDisabled: true,
                dataIndex: 'ToDo'
            },{
                text: '%Complete (Count)',
                dataIndex: 'pctCompleteCount',
                menuDisabled: true,
                renderer: function(value,meta_data,item) {
                    return Ext.create('Rally.ui.renderer.template.progressbar.ProgressBarTemplate',{
                        percentDoneName: 'pctCompleteCount',
                        calculateColorFn: function(){
                            return Rally.util.Colors.lime; //'#8DC63F';
                        }
                    }).apply(item.getData());
                }
            },{
                text: '%Complete (Effort)',
                dataIndex: 'pctCompleteEffort',
                menuDisabled: true,
                renderer: function(value,meta_data,item) {
                    return Ext.create('Rally.ui.renderer.template.progressbar.ProgressBarTemplate',{
                        percentDoneName: 'pctCompleteEffort',
                        calculateColorFn: function(){
                            return Rally.util.Colors.lime; //'#8DC63F';
                        }
                    }).apply(item.getData());
                }

            }
        ];

        if (this.showHistoricalData()){
            columns.push({
                text: 'Delta ToDo',
                dataIndex: 'deltaToDo',
                menuDisabled: true,
                renderer: function(value,meta_data,item) {
                    return value;
                }
            });
        }
        return columns;
    },
    percentRenderer: function(val){
        if (val && Number(val)){
            return (Number(val) * 100).toFixed(1) + "%";
        }
        return "";
    },
    _buildSummaryStore: function(records, snapshots){

        //now we need to ask the task records to the store
        this.userTree.processTasks(records,snapshots, this.getSelectedManagerId());

        var root = this.userTree.getUserItem(this.getSelectedManagerId());

        this.logger.log('_buildSummaryStore', root);

        return Ext.create('Ext.data.TreeStore', {
            root: { children: root.children,
                    expanded: false
            },
            model: CArABU.technicalservices.UserSummaryTaskModel
        });
    },
    getSettingsFields: function(){
        return CArABU.technicalservices.ManagerTaskReport.Settings.getFields();
    },
    getOptions: function() {
        return [
            {
                text: 'About...',
                handler: this._launchInfo,
                scope: this
            }
        ];
    },
    
    _launchInfo: function() {
        if ( this.about_dialog ) { this.about_dialog.destroy(); }
        this.about_dialog = Ext.create('Rally.technicalservices.InfoLink',{});
    },
    
    isExternal: function(){
        return typeof(this.getAppId()) == 'undefined';
    },
    
    //onSettingsUpdate:  Override
    onSettingsUpdate: function (settings){
        this.logger.log('onSettingsUpdate',settings);
        // Ext.apply(this, settings);
        this.launch();
    }
});

            
               Rally.launchApp('manager-task-report', {
                   name: 'Manager Task Report'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.configuration-error {
    color: red;
}
    </style>

</head>
<body></body>
</html>